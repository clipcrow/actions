import{phrasing as $}from"../../node_modules/mdast-util-phrasing/index.mjs";import{parents as b}from"../../node_modules/unist-util-parents/index.mjs";import{JSXSlack as v}from"../jsx.mjs";import{detectSpecialLink as g,intToAlpha as h,intToRoman as u}from"../utils.mjs";import{decodeEntity as y,escapeEntity as _}from"./escape.mjs";import{measureWidth as p,makeIndent as d}from"./measure.mjs";const m=["\u2022","\u25E6","\u25AA\uFE0E"],B=c=>{var o;return!((o=c.data)!=null&&o.codeBlock)&&$(c)};class k{constructor(o){this.codes=[],this.lists=[],this.visitors={root:t=>this.renderCodeBlock(this.block(t)),text:t=>{var e,r;if((e=t.data)!=null&&e.time)return this.visitors.time(t);if((r=t.data)!=null&&r.escape){let s=t;for(;s=s.parent;)if(s.type==="link")return this.escape(t.data.escape);return`<!date^00000000^{_}|${t.value}>`}return this.escape(t.value)},paragraph:t=>this.block(t),blockquote:t=>[...this.block(t).split(`
`),""].map(e=>`&gt; ${e}`).join(`
`),emphasis:t=>this.markup("_",this.block(t)),strong:t=>this.markup("*",this.block(t)),delete:t=>this.markup("~",this.block(t),{skipCodeBlock:!0}),inlineCode:t=>{var e;return(e=t.data)!=null&&e.codeBlock?this.visitors.code(t):this.markup("`",this.block(t))},code:t=>{const e=this.codes.length;return this.codes.push(this.block(t)),`<<code:${e}>>`},link:t=>{if(!t.url)return this.block(t);switch(g(t.url)){case"#C":case"@UW":return`<${t.url}>`;case"@S":return`<!subteam^${t.url.slice(1)}>`;case"@channel":return"<!channel|channel>";case"@everyone":return"<!everyone|everyone>";case"@here":return"<!here|here>";default:{const e=this.renderCodeBlock(this.block(t).replace(/\n+/g," "),{singleLine:!0}),r=e.match(/^(<!date\^(?!0{8}).+)\|(.+>)$/);return r?`${r[1]}^${encodeURI(t.url)}|${r[2]}`:t.url===y(e)&&!e.includes("|")?`<${e}>`:`<${encodeURI(t.url)}|${e}>`}}},list:t=>{this.lists.unshift([Math.floor(t.start-1)||0,[]]);const e=this.block(t),[,r]=this.lists.shift();let s;if(t.ordered)s=new Map(r.map(i=>[i,`${(()=>t.orderedType==="a"?h(i):t.orderedType==="A"?h(i).toUpperCase():t.orderedType==="i"?u(i):t.orderedType==="I"?u(i).toUpperCase():i.toString())()}.`]));else{const i=m[Math.min(this.lists.length,m.length-1)];s=new Map(r.map(n=>[n,i]))}const a=Math.max(...[...s.values()].map(p));return e.replace(/<<l(-?\d+)>>/g,(i,n)=>{const l=s.get(Number.parseInt(n,10)),f=p(l);return`${d(a-f)}${l} `}).replace(/<<ls>>/g,`${d(a)} `)},listItem:t=>{var e,r;let s="s";return(e=t.data)!=null&&e.implied||((r=t.data)!=null&&r.value?this.lists[0][0]=t.data.value:this.lists[0][0]+=1,this.lists[0][1].push(this.lists[0][0]),s=this.lists[0][0].toString()),this.block(t).split(`
`).map((a,i)=>`<<l${i>0?"s":s}>>${a}`).join(`
`)},time:t=>{const e=this.escape(t.data.time.datetime),r=this.escape(t.value.replace(/\n+/g," ")),s=this.escape(t.data.time.fallback);return`<!date^${e}^${r}|${s}>`},break:()=>`
`},this.block=t=>{var e,r;const s=[];let a;for(const i of t.children)a&&((e=a.data)!=null&&e.codeBlock&&s.push(`
`),B(i)||((r=s[s.length-1])!=null&&r.endsWith(`
`)||s.push(`
`),!(i.type==="list"&&this.lists.length>0)&&["paragraph","blockquote","list"].includes(a.type)&&s.push(`
`))),s.push(this.visit(i,t)),a=i;return s.join("")},this.escape=_,this.markup=(t,e,{skipCodeBlock:r=!1}={})=>{const s=v.exactMode()?`\u200B${t}\u200B`:t;return e.split(`
`).map(a=>a.replace(/^((?:&gt; )*)(.*)$/,(i,n,l)=>l&&!(r&&l.startsWith("<<code:"))?`${n}${s}${l}${s}`:`${n}${l}`)).join(`
`)},this.renderCodeBlock=(t,{singleLine:e=!1}={})=>t.replace(/<<code:(\d+)>>/g,(r,s)=>{const a=this.codes[Number.parseInt(s,10)];return e?`\`\`\`${a.replace(/\n+/g," ")}\`\`\``:`\`\`\`
${a}
\`\`\``}),this.visit=(t,e)=>this.visitors[t.type](t,e),this.root=b(o)}compile(){return this.codes=[],this.lists=[],this.visit(this.root)}}function C(c){return new k(c).compile()}export{k as MrkdwnCompiler,C as default};
